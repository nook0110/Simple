#pragma once
#include "move.h"
#include "eval.h"
#include <fstream>
#include <bitset>
#include <array>
#include <string>
#include "positionGenerator.h"
#include <omp.h>
#include <optional>
#include <mutex>
using key_t = uint_fast64_t;

// Zobrist hash keys

inline constexpr key_t psq_keys[12][64] =
{
	{
	14514284786278117030ull, 4620546740167642908ull, 13109570281517897720ull, 17462938647148434322ull, 355488278567739596ull, 7469126240319926998ull, 4635995468481642529ull, 418970542659199878ull,
	9604170989252516556ull, 6358044926049913402ull, 5058016125798318033ull, 10349215569089701407ull, 2583272014892537200ull, 10032373690199166667ull, 9627645531742285868ull, 15810285301089087632ull,
	9219209713614924562ull, 7736011505917826031ull, 13729552270962724157ull, 4596340717661012313ull, 4413874586873285858ull, 5904155143473820934ull, 16795776195466785825ull, 3040631852046752166ull,
	4529279813148173111ull, 3658352497551999605ull, 13205889818278417278ull, 17853215078830450730ull, 14193508720503142180ull, 1488787817663097441ull, 8484116316263611556ull, 4745643133208116498ull,
	14333959900198994173ull, 10770733876927207790ull, 17529942701849009476ull, 8081518017574486547ull, 5945178879512507902ull, 9821139136195250096ull, 4728986788662773602ull, 840062144447779464ull,
	9315169977352719788ull, 12843335216705846126ull, 1682692516156909696ull, 16733405176195045732ull, 570275675392078508ull, 2804578118555336986ull, 18105853946332827420ull, 11444576169427052165ull,
	5511269538150904327ull, 6665263661402689669ull, 8872308438533970361ull, 5494304472256329401ull, 5260777597240341458ull, 17048363385688465216ull, 11601203342555724204ull, 13927871433293278342ull,
	13168989862813642697ull, 13332527631701716084ull, 1288265801825883165ull, 8980511589347843149ull, 1639193574298669424ull, 14012553476551396225ull, 7818048564976445173ull, 11012385938523194722ull
	},
	{
	1594098091654903511ull, 5035242355473277827ull, 11507220397369885600ull, 4097669440061230013ull, 4158775797243890311ull, 8008476757622511610ull, 18212599999684195413ull, 3892070972454396029ull,
	15739033291548026583ull, 5240984520368774617ull, 15428220128146522508ull, 6764778500174078837ull, 17250425930626079997ull, 15862445320841941901ull, 9055707723866709616ull, 407278260229756649ull,
	6679883267401891436ull, 13585010976506536654ull, 9580697194899010248ull, 7802093638911637786ull, 535562807229422763ull, 16772549087470588412ull, 2069348082463192648ull, 18080878539236249869ull,
	12688200000096479737ull, 8989665349769173357ull, 13575112928849473200ull, 10859033464356012248ull, 9748216112997718693ull, 8405158063935141693ull, 15279502632583570477ull, 16055899490125284200ull,
	9066388900883848980ull, 17884680971936629565ull, 16395391805201036549ull, 2550532686790805254ull, 8052938288948613298ull, 6344035301348514175ull, 2193824757648316037ull, 10113332896580941759ull,
	14001553499759966766ull, 597702890888347204ull, 1874324574384293454ull, 10826913572691111562ull, 12821185545071087721ull, 14606566723149387105ull, 15679487422249894303ull, 16146086267469614290ull,
	11169330698794304272ull, 17590151747242102595ull, 18278229723818623796ull, 15994633360516603469ull, 11881756471423721131ull, 11153906733009525059ull, 16836145075420168747ull, 8614597919830747987ull,
	1459907787369619658ull, 16682004712721580156ull, 15261848763679157527ull, 2717413695111288049ull, 14889665525641206303ull, 12338480473037317818ull, 2557597240994564872ull, 12402353581130313583ull
	},
	{
	15355546302939095474ull, 17651033590338072704ull, 11616809212196625943ull, 6561978461173088746ull, 5962436378610109024ull, 1168012300494473422ull, 5175053317267933097ull, 4740525681678845797ull,
	1614376253554691208ull, 1358027693590031708ull, 1856992378370522222ull, 2410813678132517023ull, 11582456654366157909ull, 5754940895753314317ull, 17548218371729667895ull, 17945642044770404276ull,
	3721164045489467070ull, 13394551493150992827ull, 12475264300415171883ull, 10462606688633056562ull, 13251365510693735175ull, 3876338822302790600ull, 13771801863059799470ull, 13815564444636394855ull,
	16495110748802246170ull, 2156091871580385249ull, 12069080176326280986ull, 489805578737239572ull, 5271183164515543116ull, 11286401144444756863ull, 6746000579485080744ull, 5186625150343537151ull,
	13119883039086991857ull, 16025170396082521338ull, 2259331576759215945ull, 16362343102415556603ull, 10982898132796723193ull, 14666888772828547003ull, 10462483830193419334ull, 18236154274104239589ull,
	17759599582309981676ull, 9339512652453242670ull, 14635458573977612405ull, 13273192362623128494ull, 7419053614262815071ull, 2139880725825605974ull, 15336265650071823816ull, 6291952205449675957ull,
	14977329074317573394ull, 4364768269648744391ull, 17232241565077788317ull, 8450549923677533764ull, 15732483035355013039ull, 13831185231495622915ull, 6819123640184841760ull, 11886944798543888851ull,
	10879889186777890996ull, 15555433551230813341ull, 105259452319848079ull, 3441909642659419332ull, 5480947869602487239ull, 6247709904124292706ull, 13391610271247915041ull, 18346462037123761313ull
	},
	{
	16636317150577797347ull, 14149179703416851896ull, 2376171948756359367ull, 5152472389910152792ull, 2368047066677070121ull, 16396163399604156946ull, 14864288050288048653ull, 7393398358587456124ull,
	9728143941576351989ull, 5481913815176021747ull, 16927964714362701213ull, 14993236783745363262ull, 9552302871570670457ull, 11071069341174528295ull, 15381321939083200837ull, 8816171210895558106ull,
	6071991122052964372ull, 10925078611503375837ull, 15239629154712277871ull, 8615167154188153180ull, 4917230293625512515ull, 14895742215835130464ull, 2359753755290725009ull, 6783321469015983851ull,
	360705462143558065ull, 2287732638733919300ull, 2984153050512747353ull, 8021412450653308816ull, 12759258587083258672ull, 1585563973173997547ull, 18209504305389149669ull, 11416757620121532143ull,
	6846989578536141166ull, 4365862612957164362ull, 2931876801952518067ull, 680191398818283694ull, 1834352496547951770ull, 12616538556720116808ull, 17563613795929063197ull, 14519515363534791688ull,
	4349527158980778739ull, 6714794984698083967ull, 6696141578113299617ull, 17231874453010340947ull, 18425812703539835928ull, 3707544366662920973ull, 10197276740411893574ull, 12864434420502416888ull,
	12767250491273234520ull, 1588549204908870909ull, 6610295429674120152ull, 5281895767268096036ull, 1739897672032589486ull, 17406469206626426854ull, 8710378533013875691ull, 9587926405039941516ull,
	2805299725371867574ull, 7146901261023555807ull, 1825062423171923931ull, 3049052876249887095ull, 10771741767689142181ull, 8733642741329011601ull, 11979515434717210935ull, 10043245691272652957ull
	},
	{
	5830279975302858953ull, 17190113074333440499ull, 18260575806620923460ull, 14335648769917655401ull, 4153816861017702156ull, 14590500750979768984ull, 810991542442466488ull, 7089785717813579612ull,
	12357837562747114001ull, 5554121432788679660ull, 5931025703748246718ull, 2097835176693352889ull, 12745618408404359587ull, 6090924568528767236ull, 14734637834598564704ull, 14439652293742648615ull,
	132405348116615733ull, 13869945305505934743ull, 7372953811704808036ull, 7756437368369298361ull, 3794582695199039623ull, 12917619229835701974ull, 14320084076906478671ull, 2606626751703588462ull,
	3137561743724131360ull, 13808802441028589896ull, 14231944027275971054ull, 16852581317945783254ull, 10323673491841952054ull, 2313335010769237820ull, 13955532667350441768ull, 5747153089934705338ull,
	13377135145695875091ull, 6830230899286657495ull, 81856298782858401ull, 1754724887913860152ull, 13750479713795882912ull, 11120120136303124367ull, 15046307382468953177ull, 3696979254055818020ull,
	15352898388246644384ull, 1024778962410818770ull, 2388728043318081123ull, 6871857727931721608ull, 17721619206096294273ull, 10585202864517959301ull, 10898249199547365704ull, 9663430180652362739ull,
	1737102419936989910ull, 5117227310201589790ull, 16884367896390523102ull, 10498150099412419335ull, 1921007855220546564ull, 7643484074408755248ull, 11318429053286342939ull, 1370093900783164344ull,
	6776537281339823025ull, 3450492372588984223ull, 9401014545757436331ull, 7896519943553875907ull, 14303443932332314010ull, 281238069833157985ull, 9628364435514671685ull, 1035647896705322917ull
	},
	{
	940113500519447970ull, 12858978713386075837ull, 2103046007104782505ull, 1170332608028903179ull, 6569179731999105361ull, 9795365446060253382ull, 3663276878692063340ull, 11746321300354091749ull,
	5408361990473950532ull, 9735653452670998906ull, 4324195634733601175ull, 9037136744494003310ull, 10715330324656609711ull, 3474343689175121886ull, 5794004792094061662ull, 13295581273946061060ull,
	7292949743142825837ull, 10886028626057941279ull, 10688849249577735178ull, 17297010345160851373ull, 13658139148821214513ull, 4468290234101910565ull, 9583516840381960864ull, 2100818272677130469ull,
	3835407486618772476ull, 11687972045781987867ull, 2584265809482868424ull, 2184370854727222683ull, 17762352308671769689ull, 10901114407297935135ull, 17932666452350314317ull, 14800534017102555607ull,
	16233839909626358812ull, 1704089397092793640ull, 2891239861334407450ull, 18077585692287687954ull, 2363047449739120434ull, 5904357530901606076ull, 16765772907460692007ull, 8757786729323486734ull,
	3706883612695347371ull, 14958907430930711064ull, 9624134580897548276ull, 10298009507777483067ull, 5667412839234900228ull, 6828701555684071915ull, 10482797977665945217ull, 13440894740881464138ull,
	12078258924098889769ull, 5740761565098658841ull, 13914375003115830180ull, 16808960379045776034ull, 18421450170384511575ull, 16478974619417516521ull, 14381565232287562804ull, 12792472782420522791ull,
	6620422687983566193ull, 12025299949416885293ull, 6046334025019123ull, 16769051888439418536ull, 10312203372653850423ull, 720028297035890629ull, 6441255456466558203ull, 9874005816230679263ull
	},
	{
	15903170012916142038ull, 7557768652767625223ull, 17626605079857371651ull, 9092603716684679963ull, 15518831173015579794ull, 300798272301981904ull, 13762040857722893585ull, 3117104080838901168ull,
	4702649037537941245ull, 14408238429167682374ull, 17923200330177894118ull, 7470538549881440849ull, 3664543122474851710ull, 17626200978883719521ull, 15355649603762884691ull, 4749231114166154448ull,
	11220859020615935192ull, 4740127963151294603ull, 16616708905207951068ull, 9828299274924872726ull, 8985762004928355786ull, 14578866413196595465ull, 11009044264074492189ull, 16196760954725621137ull,
	10725252972011913420ull, 4601011175737567235ull, 1441938685024169613ull, 1896485105672535586ull, 6635496128279078494ull, 7401072902622950072ull, 16075245295895555285ull, 11009539992705810569ull,
	13666961049432909413ull, 930044899627839572ull, 7899294831116079515ull, 7830402010660588539ull, 5485720725031791061ull, 17051528642209786987ull, 7280223907880312904ull, 10641556535303807158ull,
	12639056541805784436ull, 12321318600465693220ull, 10108223508416203621ull, 16243972184205577210ull, 8544062083712081766ull, 11274622334580836223ull, 10844017387984539333ull, 14774228730866078526ull,
	560237794062265107ull, 5844494700804214355ull, 12270220729021534083ull, 8560016492134621125ull, 12198417933760222474ull, 10133839346494565561ull, 9295901871619786454ull, 10849442312533122519ull,
	18021432643418872607ull, 10155396024449547909ull, 10524212640889309144ull, 16662796689072019468ull, 965963318619140447ull, 8887484786999567242ull, 15714444653107301219ull, 1678356452623540647ull
	},
	{
	11052117692502964420ull, 14549914962216724919ull, 2062106447906584711ull, 9160372737526136799ull, 408961132483689555ull, 16057982805180036489ull, 3569128826873655261ull, 9330490631980133992ull,
	1176328083272936519ull, 11222898184704497134ull, 9302091588024171405ull, 10671057562378043302ull, 4098229850247478874ull, 8603114141751656125ull, 5095034292565071557ull, 17972196540767155575ull,
	17052421619317624598ull, 1582078615100434096ull, 12012345949788712038ull, 16161371278263065802ull, 2541771182459136706ull, 4555228648728151989ull, 8434259952664443907ull, 11417314755930316675ull,
	4859944209493970278ull, 3960064386733120970ull, 831798891742765072ull, 15333350611999607709ull, 16195235791627584805ull, 11597945977924582290ull, 5623573319924035254ull, 11517834322140013944ull,
	4133597640080778846ull, 5871425684860123605ull, 1689282515842046354ull, 12636468992840026995ull, 14838814546330146559ull, 521771145052581487ull, 2880434048302248640ull, 8371131723257691693ull,
	14881811984607317690ull, 1324986559026356337ull, 15096177686518116013ull, 4421234407032663127ull, 14405416956529710514ull, 3720189381923668652ull, 409223713688462738ull, 9606291214917499037ull,
	9223836018030016969ull, 190459553092726002ull, 12216883190512504355ull, 2445407445757699168ull, 4632853494959579227ull, 13184809158706083946ull, 5787237245171889527ull, 10294885203231741175ull,
	4191072920233802133ull, 4291939441266046279ull, 16375865614446560083ull, 8623994097296487259ull, 15309273767847758202ull, 9397335507036899909ull, 6747046333776906674ull, 13832845734789247298ull
	},
	{
	7019441607318179720ull, 10005910351872177492ull, 4145022192145704170ull, 4353043221960833896ull, 8973895156742077167ull, 438950987149754489ull, 2185272607213603213ull, 8466605802960622962ull,
	12110999198806592422ull, 11821045514824268224ull, 10878266882585355136ull, 11760743717116988087ull, 4184976790109698342ull, 18330309416210613006ull, 1107206443001387417ull, 79384941109554222ull,
	9163366224008952362ull, 3321824684344751056ull, 3693723307432954164ull, 6079394558849393056ull, 11401125038466760935ull, 3656219353656357222ull, 1735342045865967049ull, 4042759343240967690ull,
	12711975181279962687ull, 9500297538285176400ull, 15298274009373410204ull, 9806309365986113958ull, 10640867530898511005ull, 17462737140104853956ull, 4414872795937286161ull, 14852747253248972903ull,
	15278706409822090441ull, 6433625831299907179ull, 3321907667985685429ull, 11390693584827212740ull, 11529629266037992234ull, 10328859824139248147ull, 16428469301035734767ull, 17926643922068445985ull,
	705326063324784242ull, 8105287564212541268ull, 15433828269766668455ull, 3714790519415313767ull, 5417718938962187987ull, 7847045502609209896ull, 8025090526912661197ull, 2234136672994823541ull,
	16041001438425499955ull, 10050820915370092068ull, 14731208739754682952ull, 9320476318639351023ull, 14993011533295358880ull, 4179632880986595543ull, 8947621078428360390ull, 14715184767037401701ull,
	2617407252848328649ull, 4818108510694228841ull, 3602814087839803186ull, 14679368779377024657ull, 7354547195052671772ull, 453184876960970470ull, 15781004944602184656ull, 12000277437894508493ull
	},
	{
	14990587330205222466ull, 13913588124149397652ull, 14252160166631667289ull, 1532590395334038243ull, 10283229111568663870ull, 17325140074534683390ull, 15829693190940193580ull, 7621681592523599724ull,
	10682206684717316020ull, 1847393779801417006ull, 3066262069769536156ull, 14633662576956154615ull, 15324290530255177253ull, 14627271171597064522ull, 14334883061544405592ull, 12329324284039697670ull,
	14425669906700626239ull, 4967072546582904838ull, 11336784484312139551ull, 9293117687355182150ull, 18198595579111618687ull, 3236555730692485133ull, 3659681352365625914ull, 5185822088933195476ull,
	1820961806679957133ull, 5103404090674191862ull, 16176358349875499548ull, 15699479324816269479ull, 6929077312607579230ull, 7724671543660786314ull, 15226863704421704735ull, 10411799650043017788ull,
	2743533500235068318ull, 7917895244279791454ull, 9194839772540541837ull, 8170679394364395846ull, 2830213237197365734ull, 7353896603754987224ull, 17634372441601249827ull, 8515117661105161813ull,
	5818937363197514778ull, 8536843065945835629ull, 2920190566549352463ull, 4206179361653770600ull, 15470355568872211976ull, 8427825008315838911ull, 5786540713287383830ull, 15547153445796060183ull,
	12329720415526259303ull, 5557519966701086911ull, 17778904544770937806ull, 17514165232876376499ull, 17788126989478779154ull, 17150186057659184837ull, 96482940290395907ull, 5391763100021787727ull,
	13311921842198397018ull, 212666859219880844ull, 17021563369181645958ull, 11336487866339302675ull, 9141466969851850320ull, 15662548514627491449ull, 7860565965198889264ull, 13899151565605256321ull
	},
	{
	13381351357933618242ull, 14888589325358078776ull, 8892463471491396086ull, 15103645417329254911ull, 5461076326426815327ull, 1842242118931503497ull, 4404875173572687401ull, 13971514988681285540ull,
	17325818256926300242ull, 15093194250549176553ull, 2037055123708268678ull, 16257942776085749532ull, 10590700494563920368ull, 9510359897405254265ull, 14355127120473277462ull, 17727696335014918206ull,
	5852409884542362577ull, 15296449745630772621ull, 15183080793648581194ull, 16672300287494724460ull, 13969062191570534211ull, 9287911224447475220ull, 8201339388669403090ull, 6896471492123786378ull,
	17836899414146968932ull, 18212192901661339968ull, 13589433629948059304ull, 11028761701391980161ull, 6774257768766057466ull, 12173254712476586450ull, 12848080044100037611ull, 8528727180962924144ull,
	1419515180397454273ull, 14756964613420120449ull, 5897971337265509756ull, 7895151636400005603ull, 12470640271491881548ull, 1601970429693801261ull, 15095880759160767112ull, 9199134360165595311ull,
	3011979166743445660ull, 12194258846860258337ull, 3655956427657893470ull, 2336006494839215747ull, 14852738832219225696ull, 980198724853947166ull, 15813714724821744703ull, 791599627749143069ull,
	7348649629500435093ull, 15262170387612229708ull, 15303522042429377318ull, 8425613881574971669ull, 15801520478161584059ull, 14074339996639769183ull, 11257371430211006951ull, 13402846107666422911ull,
	6626174270103647993ull, 14681865631183261473ull, 4451829808427344249ull, 5724496674828323027ull, 14972202730373011904ull, 11481387700399791014ull, 17251674197980054589ull, 1838448127446963389ull
	},
	{
	1207376433173020767ull, 9073502573042965711ull, 13838468943242852421ull, 5020402172333584866ull, 1289816897702617855ull, 16074253538753775279ull, 2848619861528754568ull, 5973640488400207347ull,
	3071333206607986706ull, 12888295794552218363ull, 5137015169022219459ull, 6855845130657996130ull, 13509486497434551605ull, 3108141178579225625ull, 11547672040624451730ull, 8228290404814299648ull,
	556050802577131935ull, 1291564719606180243ull, 12244181387410231701ull, 278862824664555643ull, 15819233907350967248ull, 17068340672410761541ull, 18086332283553587440ull, 315661412098236862ull,
	2955724640055190386ull, 13784171517969596718ull, 1290092202280378555ull, 16592960356544350813ull, 16858716830044052167ull, 897800245874941430ull, 13540719245109081222ull, 1083645675370617492ull,
	1386604666325681943ull, 15322508077521817796ull, 17200996622826525908ull, 377359248448239623ull, 903752203431456047ull, 5917034777147383262ull, 14427307358937396394ull, 7312697203701764121ull,
	16205567221211754073ull, 2397860267640591749ull, 7771620645425797965ull, 4628927853429026927ull, 10814117705525372791ull, 1781328114115837238ull, 8047892713447387890ull, 14325316982420673798ull,
	307254776259779147ull, 18088484138876255865ull, 6235903010317883578ull, 4576014393928771646ull, 11902339501721522128ull, 11466077100832512450ull, 1320279640819393445ull, 7149459462530810516ull,
	17183597293436304345ull, 10494281344202625434ull, 15351591175592386700ull, 6787100053213878886ull, 4662750932232247137ull, 9155970812684385713ull, 16135661826301908461ull, 18304055221177982100ull
	}
};

inline constexpr key_t enpass[8] =
{
9416630457538799891ull, 14565714036259547408ull, 1567015689328697302ull, 6354592639376292074ull, 17850376331797597416ull, 10659961423006612289ull, 17519724454480552469ull, 11678126474628634190ull
};

inline constexpr key_t sideToMoveKey = 1;

struct Position {

	std::array<Piece, 64> board;
	unsigned char sideToMove;
	square enPassantSquare = -1;
	std::array<CastlingRight, COLOR_NONE> cr = {CR_ALL, CR_ALL};
	std::array<std::array<bitboard, CR_ALL>, COLOR_NONE> castlingPath;

	key_t hash = 0;

	inline size_t address() const;

	std::array<bitboard, COLOR_NONE> color;
	std::array<bitboard, 12> pieces;

	// tapered evaluation data

	std::array<value, COLOR_NONE> nonPawnMaterial = { 0, 0 };
	std::array<value, PHASE_NONE> pieceValuesSum = { 0, 0 };
	std::array<value, PHASE_NONE> psqtBonusSum = { 0, 0 };

	Piece& operator[](const size_t ind) { return board[ind]; }
	const Piece& operator[](const size_t ind) const { return board[ind]; }

	std::array<square, COLOR_NONE> kingPos;

	// helpers

	void place(const Square& square, const Piece piece);
	void remove(const Square& square);

	void doMove(const Move& move);
	void undoMove(const Move& move);

	const bitboard pawns(const Color color) const;
	const bitboard queen(const Color color) const;
	const bitboard king(const Color color) const;
	bitboard pawnAttacks(const Color color) const;

	const bool underAttack(const square sq, const Color us) const;
	const bool underCheck(const Color us) const;
	const bool canCastle(const Color us, const CastlingRight cr) const;

	// evaluation

	std::array<bitboard, COLOR_NONE> avaliableArea;
	std::array<value, PHASE_NONE> eval;

	const value evaluate();

	void init(std::string FEN, std::string move);
	void initCastlingPath();


	std::vector<Move> generateAttacks();
	std::vector<Move> generateMoves();

	Move findBestMove(unsigned char maxDepth);

	std::optional<value> findAlphaBeta(int depth, value alpha, value beta, const Move& previous, const const unsigned char maxDepth);
	std::optional<value> quiesce(int depth, value alpha, value beta);
};

void findMove(Position& pos, const std::vector<Move>& moves, value& alpha, value& beta, Move& bestMove, unsigned char maxDepth);

extern Position position;